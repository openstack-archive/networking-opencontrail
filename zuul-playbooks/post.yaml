- hosts: all
  roles:
    - export-devstack-journal
    - devstack-project-conf
    - capture-system-logs
    - fetch-devstack-log-dir
  vars:
    contrail_dirs:
      config: "~/contrail-ansible-deployer"
      logs: "/var/log/contrail"
      logs_staged: "{{ zuul.executor.log_root }}/contrail"
    docker_dirs:
      config: "/etc/docker"
      config_staged: "{{ zuul.executor.log_root }}/docker"
  tasks:
    - name: "Ensure {{ contrail_dirs.logs_staged }} path exists"
      become: yes
      file:
        path: "{{ contrail_dirs.logs_staged }}"
        state: directory
    - name: Fetch contrail-ansible-deployer config files
      ignore_errors: yes
      become: yes
      synchronize:
        src: "{{ contrail_dirs.config }}/{{ item }}"
        dest: "{{ contrail_dirs.logs_staged }}/{{ item }}"
        mode: pull
        recursive: yes
      with_items:
        - "config/instances.yaml"
        - "inventory/hosts"
        - "ansible.cfg"
    - name: Fetch contrail logs
      ignore_errors: yes
      become: yes
      synchronize:
        src: "{{ contrail_dirs.logs }}"
        dest: "{{ contrail_dirs.logs_staged }}"
        mode: pull
    - name: "Ensure {{ docker_dirs.config_staged }} path exists"
      become: yes
      file:
        path: "{{ docker_dirs.config_staged }}"
        state: directory
    - name: Fetch docker config files
      ignore_errors: yes
      become: yes
      synchronize:
        src: "{{ docker_dirs.config }}"
        dest: "{{ docker_dirs.config_staged }}"
        mode: pull
    - name: List running containers
      command: 'docker ps --format "{{.Names}}: {{.Status}}"'
      register: running_containers_list
