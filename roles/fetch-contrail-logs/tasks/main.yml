---
- name: Set contrail-ansible-deployer path
  set_fact:
    contrail_deployer_path: "/home/zuul/contrail-ansible-deployer"
  when: contrail_deployer_path is undefined

- name: Check if /var/log/contrail directory exists
  stat:
    path: "/var/log/contrail"
  register: contrail_logs_dir

- name: Copy contrail logs
  become: yes
  synchronize:
    src: "/var/log/contrail"
    dest: "{{ zuul.executor.log_root }}/controller/logs"
    mode: pull
  when: contrail_logs_dir.stat.exists

- name: "Check if {{ contrail_deployer_path }} direcotry exists"
  stat:
    path: "{{ contrail_deployer_path }}"
  register: contrail_deployer

- name: Create temporary directory for contrail config files
  file:
    path: "/home/zuul/contrail_conf"
    state: directory
    mode: a=rw

- name: Prepare contrail-ansible-deployer config files for sync
  shell: |
    set -e
    set -x
    cp {{ contrail_deployer_path }}/ansible.cfg /home/zuul/contrail_conf/
    cp {{ contrail_deployer_path }}/inventory/hosts /home/zuul/contrail_conf/
    cp {{ contrail_deployer_path }}/config/instances.yaml /home/zuul/contrail_conf/
  when: contrail_deployer.stat.exists

- name: Copy contrail-ansible-deployer config files
  become: yes
  synchronize:
    src: "/home/zuul/contrail_conf/"
    dest: "{{ zuul.executor.log_root }}/controller/logs/"
    mode: pull
  when: contrail_deployer.stat.exists
