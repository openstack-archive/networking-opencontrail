---
- name: Install required utilities
  become: yes
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - python-pip
    - git

- name: Remove PyYAML package
  # due to error in PIP: Cannot uninstall 'PyYAML'. It is a distutlis insatlled project
  # and thus we cannot accurately determine which files belong to it
  # which would lead to only a partial uninstall.
  # PyYAML is installed in task: 'Install python packages'
  become: yes
  yum:
    name: PyYAML
    state: removed

- name: Add docker-ce repository
  become: yes
  shell: |
    yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  args:
    executable: /bin/bash

- name: Install docker
  become: yes
  yum:
    name: docker-ce
    state: present

- name: Start docker daemon
  become: yes
  service:
    name: docker
    state: running
    enabled: yes

- name: Install python packages
  become: yes
  pip:
    name: PyYAML
    state: present
    extra_args: --ignore-installed

- name: Install Ansible
  become: yes
  yum:
    name: ansible-2.4.*
    state: present

# In zuul environment docker needs explicit DNS configuration
- name: Create docker configuration file with IP of nameservers
  shell: |
    set -e
    set -x
    sudo mkdir -p /etc/docker
    echo "{\"dns\": [\"1.1.1.1\", \"8.8.8.8\"]}" | sudo tee /etc/docker/daemon.json

# Dirty ugly workaround on contrail-ansible-deployer not using 'become' in playbooks
- name: Create directories for contrail
  shell: |
    set -e
    set -x
    sudo mkdir -p /var/log/contrail
    sudo mkdir -p /etc/contrail
    sudo chmod 777 /var/log/contrail /etc/contrail
